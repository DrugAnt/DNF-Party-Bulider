{% extends 'base.html' %}

{% block content %}
  <h2>파티 생성/리스트</h2>

  {# 플래시 메시지 #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div>
        {% for category, msg in messages %}
          <div class="flash {{ category }}">
            {{ msg|replace('\n','<br>')|safe }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <style>
    /* 완료된 파티 회색 처리 */
    .completed {
      filter: grayscale(100%);
      opacity: 0.6;
    }

    .party-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 2rem;
    }

    .party-list {
      flex: 0 0 auto;
    }
    .party-list table {
      width: 65ch;
      table-layout: fixed;
      margin-bottom: 1rem;
    }

    /* 오른쪽 네비: 필터 + 남은 캐릭터 */
    .abandon-list {
      flex: 0 0 40ch;
      margin-left: auto;
      position: sticky;
      top: 1rem;
      max-height: calc(100vh - 6rem);
      overflow-y: auto;
      padding: 0.5rem;
      border: 1px solid #ddd;
      background: #fafafa;
    }
    .abandon-list h3 { margin: 0.5rem 0 0.25rem; font-size:1.1rem; border-bottom:1px solid #ccc; padding-bottom:0.25rem; }
    .abandon-list .filter-options { list-style:none; padding:0; margin:0.5rem 0 1rem; }
    .abandon-list .filter-options li { margin-bottom:0.25rem; font-size:0.9rem; }
    .abandon-list .filter-options label { display:flex; align-items:center; }
    .abandon-list .filter-options input { margin-right:0.25rem; }
    .abandon-list .mode-toggle { margin-bottom:1rem; font-size:0.9rem; }
    .abandon-list ul.characters { list-style:none; padding:0; margin:0.5rem 0; }
    .abandon-list ul.characters li {
      margin-bottom:0.5rem;
      padding:0.5rem;
      border:1px solid #ccc;
      border-radius:4px;
      background:#fff;
      font-size:0.9rem;
    }
  </style>

  <div style="margin-bottom:1rem;">
    <form method="get" action="" style="display:inline;">
      <label for="role-select">유형 선택:</label>
      <select id="role-select" name="role" onchange="this.form.submit()">
        <option value="temple" {% if selected=='temple' %}selected{% endif %}>Temple</option>
        <option value="azure"  {% if selected=='azure'  %}selected{% endif %}>Azure</option>
        <option value="venus"  {% if selected=='venus'  %}selected{% endif %}>Venus</option>
      </select>
    </form>
    <form method="post" action="" style="display:inline; margin-left:0.5rem;">
      <input type="hidden" name="role" value="{{ selected }}">
      <button type="submit">파티 재생성</button>
    </form>
  </div>

  {% if parties %}
    <div class="party-wrapper">
      <!-- 왼쪽: 파티 목록 -->
	    {% set prefixes = {
		  'temple': '여',
		  'azure' : '애',
		  'venus' : '베'
		} %}
	  
      <div class="party-list">
        {% for p in parties %}
		  {# ① 바깥 루프 인덱스를 partyIndex 에 저장 #}
		  {% set partyIndex = loop.index %}
          <table class="border table-auto {% if p.is_completed %}completed{% endif %}" data-id="{{ p.id }}">
            <colgroup>
              <col style="width:7ch">
              <col style="width:15ch">
              <col style="width:28ch">
              <col style="width:15ch">
              <col style="width:8ch">    <!-- 액션 열 -->
            </colgroup>
            <thead class="bg-gray-100">
              <tr>
                <th>{{ prefixes[selected] }}{{ loop.index }}</th>
                <th>모험단</th>
                <th>이름(직업)</th>
                <th>스코어</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {# 버퍼 1 #}
			  <tr class="border-b">
			    <td>버퍼1</td>
			    <td>{{ p.buffer.adventure }}</td>
			    <td>{{ p.buffer.chara_name }} ({{ p.buffer.job }})</td>
			    <td class="text-right">{{ "{:,}".format(p.buffer.score) }}</td>
			    <td class="swap-col">
				  <button class="swap-out-btn"
				          data-role="buffer"
				          data-index="0"
				          data-party="{{ partyIndex }}"
				          data-slot="{{ i }}"
				  >OUT</button>
			    </td>
			  </tr>
              {# 딜러 3명 #}
			  {% for i in range(3) %}
			    {% set d = p.dealers[i] %}
			    <tr class="border-b">
				  <td>딜러{{ i+1 }}</td>
				  {% if d %}
				    <td>{{ d.adventure }}</td>
				    <td>{{ d.chara_name }} ({{ d.job }})</td>
					<td class="text-right">
					  {% if d.isbuffer %}
						{{ "{:,}".format(d.score) }}
					  {% else %}
						{{ d.score | int | korean }}
					  {% endif %}
					</td>
				  {% else %}
				    <td colspan="2" class="text-center">—</td>
				    <td>—</td>
				  {% endif %}
				  <!-- 빈칸이든 아니든 항상 OUT 버튼 -->
				  <td class="swap-col">
				    <button class="swap-out-btn" data-role="dealer" data-index="{{i}}" data-party="{{ partyIndex }}"  {# ← 여기 #} data-slot="{{ i }}">OUT</button>
				  </td>
  			    </tr>
			  {% endfor %}
              {# 합산 점수 + 완료 버튼 #}
				<tr class="bg-gray-100">
				  <td colspan="3" class="text-right font-semibold">합산 점수</td>
				  <td class="text-right font-semibold">
					{{ "{:.2f}".format(p.result) if p.result is not none else '—' }}
				  </td>
				  <td>
					{% if not p.is_completed %}
					  <form method="post"
							action="{{ url_for('party.complete_party') }}"
							onsubmit="return confirm('이 파티를 던전 클리어 처리하시겠습니까?');">
						<input type="hidden" name="party_id" value="{{ p.id }}">
						<input type="hidden" name="role"     value="{{ selected }}">
						<button type="submit">완료</button>
					  </form>
					{% else %}
					  <form method="post"
							action="{{ url_for('party.uncomplete_party') }}"
							onsubmit="return confirm('이 파티를 미완료 상태로 되돌리시겠습니까?');">
						<input type="hidden" name="party_id" value="{{ p.id }}">
						<input type="hidden" name="role"     value="{{ selected }}">
						<button type="submit">복원</button>
					  </form>
					{% endif %}
				  </td>
				</tr>
            </tbody>
          </table>
        {% endfor %}
      </div>

	  <!-- 2) 새로 추가할 중간 네비게이터 -->
	  <div class="middle-list">
	    <h3>캐릭터 편집</h3>

	    <button id="edit-members-btn" class="filter-btn">
		  멤버 편집
	    </button>
		
		<div id="swap-ui" style="display:none; margin-top:0.1rem; border-top:1px solid #ccc; padding-top:0.1rem;">
		  <div><strong>OUT</strong></div>
		  <div id="out-list" class="characters">
		    <p>(비어있음)</p>
		  </div>    {# 기존 남은 캐릭터 블록 스타일 재활용 #}

		  <div style="margin:0.5rem 0;"><strong>IN</strong></div>
		  <div id="in-list" class="characters">
			<p>(비어있음)</p>
		  </div>

		  <div style="margin-top:1rem; text-align:right;">
			<button id="confirm-swap-btn">확인</button>
			<button id="cancel-swap-btn">취소</button>
		  </div>
		</div>
	  </div>

      <!-- 오른쪽: 필터 + 남은 캐릭터 -->
      <div class="abandon-list">
        <h3>모험단 필터</h3>
        <ul id="filter-options" class="filter-options">
          <!-- JS에서 체크박스 삽입 -->
        </ul>
			<div class="mode-toggle">
			  <div><label><input type="checkbox" id="filter-mode"> 하나라도 일치 (OR 모드)</label></div>
			  <div><label><input type="checkbox" id="show-completed"> 클리어된 파티 일반 정렬</label></div>
			</div>
			
		<h3>남은 캐릭터</h3>
		{% if abandoned %}
			<ul class="characters">
			  {% for c in abandoned %}
				<li>
				  <div class="character-card">
					<div class="card-top">
					  {{ c.adventure }} — {{ c.chara_name }} ({{ c.job }})
					</div>
					<div class="card-bottom">
					  <span>[{{ '버퍼' if c.isbuffer else '딜러' }}] • 점수: {{ "{:,}".format(c.score) }}</span>
					  <button class="swap-in-btn" disabled>IN</button>
					</div>
				  </div>
				</li>
			  {% endfor %}
			</ul>
		{% else %}
		  <p>남은 캐릭터가 없습니다.</p>
		{% endif %}
      </div>
    </div>
  {% else %}
    <div class="text-center text-gray-600 mt-8">
      해당 유형의 파티가 없습니다.<br>
      위에서 <strong>파티 재생성</strong> 버튼을 눌러주세요.
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ── 1) 필터/정렬 로직 ──
  const STORAGE_KEY   = 'partyFilterState';
  const optsContainer = document.getElementById('filter-options');
  const modeToggle    = document.getElementById('filter-mode');
  const showCompleted = document.getElementById('show-completed');

  // 모험단 체크박스 생성
  const advSet = new Set();
  document.querySelectorAll('.party-list table tbody tr').forEach(tr => {
    if (tr.children[0].textContent.trim() === '합산 점수') return;
    const adv = tr.children[1].textContent.trim();
    if (adv && adv !== '—') advSet.add(adv);
  });
  Array.from(advSet).sort().forEach(adv => {
    const li  = document.createElement('li');
    const lbl = document.createElement('label');
    const chk = document.createElement('input');
    chk.type      = 'checkbox';
    chk.className = 'filter-checkbox';
    chk.value     = adv;
    lbl.append(chk, document.createTextNode('\u00A0' + adv));
    li.appendChild(lbl);
    optsContainer.appendChild(li);
  });

  // data-adventures 설정
  document.querySelectorAll('.party-list table').forEach(table => {
    const advs = Array.from(table.querySelectorAll('tbody tr'))
      .filter(tr => tr.children[0].textContent.trim() !== '합산 점수')
      .map(tr => tr.children[1].textContent.trim());
    table.dataset.adventures = advs.join(',');
  });

  // 저장된 필터 상태 복원
  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  if (Array.isArray(saved.checked)) {
    document.querySelectorAll('.filter-checkbox').forEach(chk => {
      chk.checked = saved.checked.includes(chk.value);
    });
  }
  if (typeof saved.orMode === 'boolean')  modeToggle.checked    = saved.orMode;
  if (typeof saved.showCompleted === 'boolean') showCompleted.checked = saved.showCompleted;

  // 필터 함수
  function applyFilter() {
    const checked = Array.from(document.querySelectorAll('.filter-checkbox:checked'))
                         .map(i => i.value);
    const orMode = modeToggle.checked;
    document.querySelectorAll('.party-list table').forEach(tbl => {
      const advs = tbl.dataset.adventures.split(',');
      const show = !checked.length ||
                    (orMode
                      ? checked.some(v => advs.includes(v))
                      : checked.every(v => advs.includes(v)));
      tbl.style.display = show ? '' : 'none';
    });
  }

  // 정렬 함수
  function applySort() {
    const container = document.querySelector('.party-list');
    const tables    = Array.from(container.querySelectorAll('table'));
    const includeCompleted = showCompleted.checked;
    tables.sort((a, b) => {
      const aComp = a.classList.contains('completed');
      const bComp = b.classList.contains('completed');
      if (includeCompleted) {
        return Number(a.dataset.id) - Number(b.dataset.id);
      }
      if (aComp !== bComp) {
        return aComp ? 1 : -1;
      }
      return Number(a.dataset.id) - Number(b.dataset.id);
    });
    tables.forEach(tbl => container.appendChild(tbl));
  }

  // 상태 저장 & 재적용
  function onStateChange() {
    const checked = Array.from(document.querySelectorAll('.filter-checkbox:checked'))
                         .map(i => i.value);
    localStorage.setItem(
      STORAGE_KEY,
      JSON.stringify({
        checked,
        orMode: modeToggle.checked,
        showCompleted: showCompleted.checked
      })
    );
    applyFilter();
    applySort();
  }

  document.querySelectorAll('.filter-checkbox').forEach(chk =>
    chk.addEventListener('change', onStateChange)
  );
  modeToggle.addEventListener('change', onStateChange);
  showCompleted.addEventListener('change', onStateChange);

  applyFilter();
  applySort();

  // ── 2) 파티 멤버 편집 로직 ──
  const editBtn    = document.getElementById('edit-members-btn');
  const swapUI     = document.getElementById('swap-ui');
  const outList    = document.getElementById('out-list');
  const inList     = document.getElementById('in-list');
  const confirmBtn = document.getElementById('confirm-swap-btn');
  const cancelBtn  = document.getElementById('cancel-swap-btn');
  
  function initSwap() {
    outList.innerHTML = '<p>(비어있음)</p>';
    inList.innerHTML  = '<p>(비어있음)</p>';
  }

  function updateInButtons() {
    const hasOut = !!outList.querySelector('.character-card');
    document.querySelectorAll('.character-card .swap-in-btn').forEach(btn => {
      btn.disabled = !hasOut;
      btn.style.opacity = hasOut ? '1' : '0.5';
      btn.style.cursor  = hasOut ? 'pointer' : 'not-allowed';
    });
  }

  editBtn.addEventListener('click', () => {
    swapUI.style.display  = '';
    editBtn.style.display = 'none';
    document.body.classList.add('editing');
    initSwap();
    updateInButtons();
  });

  // OUT 버튼 클릭
  document.querySelectorAll('.swap-out-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // 이전 선택 해제
      document.querySelectorAll('.swap-out-btn.selected').forEach(b => {
        b.classList.remove('selected');
        b.closest('tr').classList.remove('selected-row');
      });
      // 새 선택 강조
      btn.classList.add('selected');
      const row = btn.closest('tr');
      row.classList.add('selected-row');

      // OUT 카드 렌더
      const partyIndex = btn.dataset.party;
      const rawSlot    = Number(btn.dataset.slot) + 1;
      const adv        = row.children[1].textContent.trim();
      const nameJob    = row.children[2].textContent.trim();
      const score      = row.children[3].textContent.trim();
      const role       = btn.dataset.role === 'buffer' ? '버퍼' : '딜러';
      const slotIndex  = role === '딜러' ? rawSlot + 1 : 1;

      outList.innerHTML = '';
      const card = document.createElement('div');
      card.className = 'character-card';
      card.innerHTML = `
        <div class="card-top">${adv} — ${nameJob}</div>
        <div class="card-bottom">${role} - ${score} / ${partyIndex}파티 - ${slotIndex}번</div>
      `;
      outList.appendChild(card);
      updateInButtons();
    });
  });

  // 취소
  cancelBtn.addEventListener('click', e => {
    e.preventDefault();
    swapUI.style.display  = 'none';
    editBtn.style.display = '';
    document.body.classList.remove('editing');
    document.querySelectorAll('.swap-out-btn.selected').forEach(b => b.classList.remove('selected'));
    document.querySelectorAll('tr.selected-row').forEach(tr => tr.classList.remove('selected-row'));
    initSwap();
    updateInButtons();
  });

  // 확인 (저장)
  confirmBtn.addEventListener('click', e => {
    e.preventDefault();
    // TODO: AJAX or form.submit 으로 저장
    swapUI.style.display  = 'none';
    editBtn.style.display = '';
    document.body.classList.remove('editing');
    document.querySelectorAll('.swap-out-btn.selected').forEach(b => b.classList.remove('selected'));
    document.querySelectorAll('tr.selected-row').forEach(tr => tr.classList.remove('selected-row'));
    updateInButtons();
  });

  
  // ── 3) IN 버튼 클릭 (이벤트 위임) ──
  const abandonList = document.querySelector('.abandon-list');
  if (abandonList) {
    abandonList.addEventListener('click', e => {
      if (!e.target.matches('.swap-in-btn')) return;
      const li   = e.target.closest('li[data-char]');
	  if (!li) {
		console.warn('swap-in-btn 클릭했지만 data-char li를 찾지 못함:', e.target);
		return;
	  }
	  
      const json = li.dataset.char;
	  if (!json) {
		console.warn('data-char가 비어있음:', li);
		return;
	  }
      const data = JSON.parse(json);

      inList.innerHTML = '';
      const card = document.createElement('div');
      card.className = 'character-card';
      card.innerHTML = `
        <div class="card-top">${data.adventure} — ${data.chara_name} (${data.job})</div>
        <div class="card-bottom">[${data.isbuffer ? '버퍼' : '딜러'}] • 점수: ${data.score.toLocaleString()}</div>
      `;
      inList.appendChild(card);
      updateInButtons();
    });
  }
});
</script>
{% endblock %}
